---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ChIPpeakAnno)
library(TxDb.Mmusculus.UCSC.mm9.knownGene)
library(UpSetR)
```


```{r}
k9_summary <- readr::read_tsv('./data/GSE44854/epic2/AcH3K9_summary')
head(k9_summary)
```

```{r}
k9_summary %>%
  filter(pvalue_B_vs_A < 1) %>%
  ggplot(aes(x = log2(Fc_B_vs_A), y = -log10(pvalue_B_vs_A))) +
    geom_point()
```
```{r}
k9_summary %>%
  filter(pvalue_A_vs_B < 1) %>%
  ggplot(aes(x = log2(Fc_A_vs_B), y = -log10(pvalue_A_vs_B))) +
    geom_point() +
    xlim(-3, 3) +
    ylim(0, 25)
```

```{r}
h3k4me3_12wks_str <- readr::read_tsv('./data/GSE48960/str_12/results/epic2/12_wks_str.tsv')
```

```{r}
h3k4me3_12wks_str %>%
  filter(P_KO < 1) %>%
  ggplot(aes(x = log2(FC_KO), y = -log10(P_KO))) +
    geom_point()
```

```{r}
h3k4me3_12wks_str %>%
  filter(FDR_KO < 0.00000001)
```

```{r}
peaks <- toGRanges(h3k4me3_12wks_str %>% filter(FDR_KO < 0.1))
```
```{r}
annoData <- toGRanges(TxDb.Mmusculus.UCSC.mm9.knownGene)
```

```{r}
seqlevelsStyle(peaks) <- seqlevelsStyle(annoData)
anno <- annotatePeakInBatch(peaks, AnnotationData=annoData)
```

```{r}
anno <- annotatePeakInBatch(peaks, AnnotationData=annoData, 
                  output="overlapping", 
                  FeatureLocForDistance="TSS",
                  bindingRegion=c(-2000, 3000))
anno$symbol <- xget(anno$feature, org.Mm.egSYMBOL)
head(anno)
```

### Transcriptional dysregulation

```{r}
array_10 <- readr::read_tsv('./out/GSE44855_hip_10_sig.tsv')
array_20 <- readr::read_tsv('./out/GSE44855_hip_20_sig.tsv')
rna_seq_ctx <- readr::read_tsv('./out/GSE48963_ctx_12_sig.tsv')
rna_seq_str <- readr::read_tsv('./out/GSE48963_str_12_sig.tsv')
```

```{r}
all_de_genes = list(
  "Hippocampus, 10 weeks" = array_10$gene_symbol,
  "Hippocampus, 20 weeks" = array_20$gene_symbol,
  "Cortex, 12 weeks" = rna_seq_ctx$gene_symbol,
  "Striatum, 12 weeks" = rna_seq_str$gene_symbol
)
```

```{r}
upset(fromList(all_de_genes), order.by = "freq")
```

```{r}
Reduce(intersect, all_de_genes)
```

